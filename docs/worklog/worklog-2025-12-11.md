# Worklog - December 11, 2025

## Summary

Major data cleanup to revert the course merges from December 4th and restore the system to a 1:1 mapping between external CSV data and our database. The December 4th merge caused issues with CSV Compare because "loser" course IDs were deleted but still existed in the external_training table.

**End Result:** 100% CSV match rate - every course in external_training now has a corresponding course in our DB, a position assignment, and a training record.

---

## Background: What Went Wrong on December 4th

On December 4th, we merged duplicate courses using a "winner/loser" system:
- Courses with the same T-code (e.g., T586 Parent, T586 IL, T586 OL) were consolidated
- A "winner" was picked based on position count + training record count
- "Loser" courses were deleted and their records transferred to the winner

**The Problem:** The external_training table (CSV import) still had the original "loser" course IDs. When CSV Compare ran, it showed those courses as "Not Found" because the IDs no longer existed in our system.

### Example: T586 Before Revert
- **Winner:** 13754 (T586 Bead Blast Training Parent) - kept
- **Losers deleted:**
  - 13531 (T586 Bead Blasting Parent)
  - 13653 (T586 OJT)
  - 14598 (T586 IL OL)

External CSV still had records for 13653 and 14598, but those courses were gone!

---

## Step 1: Reverted Course Merges

### Script: `scripts/revert-course-merges.ts`

Parsed the audit CSV from December 4th and undid all the merges:

1. **Deleted 62 "winner" courses** that were created from merges
2. **Recreated 62 courses** from external_training (source of truth)
3. **Re-imported 5,290 training records** from external_training
4. **Skipped 2,038 duplicates** (already existed)

### T-Codes That Were Unmerged

| T-Code | Courses Restored | Notes |
|--------|------------------|-------|
| T121 | 13772 | Material Handling Parent |
| T133 | 14054 | Measurement of Cables OL |
| T134 | 13546 | FAI Training OL |
| T137 | 13560 | Micrometers IL OJT |
| T142 | 999019, 13533 | PMR Training IL, Parent |
| T143 | 13532 | MRB Training OL |
| T202 | 13753 | Electrical Soldering Parent |
| T211 | 13482 | Basic Mechanical Assembly OL |
| T301 | 13565, 999046 | PCB Rework OL, Parent |
| T302 | 13751 | Surface Mount Rework Parent |
| T321 | 13572 | ESD Technician OL |
| T504 | 13749 | Wave Solder Parent |
| T505 | 13752 | Surface Mount Assembly Parent |
| T508 | 13756 | Welding-Aluminum Parent |
| T510 | 999033 | Tinning Stranded Wire Parent |
| T515 | 13750 | Torque Training Parent |
| T519 | 13764 | Crimping Parent |
| T521 | 999021, 999039 | Dichromate OJT, Parent |
| T522 | 13763 | Brush Chem Film Parent |
| T524 | 13768 | Chromate Conversion Parent |
| T525 | 13758 | Metal Cleaning Parent |
| T528 | 13769 | Electroform Nickel Parent |
| T570 | 14644 | Salt Spray Chamber Parent |
| T572 | 999034 | Adhesion Tape Testing Parent |
| T575 | 999035 | Copper Sulfate Testing Parent |
| T576 | 99988 | ID Sanding Parent |
| T579C | 13761 | Potting Parent |
| T586 | 13531 | Bead Blasting Parent |
| T701 | 13760 | Corrosion Resistant Parent |
| T709 | 14654 | Sulfuric Anodize Parent |
| T717 | 14350, 14351 | Machine Guarding IL, OL |
| T719 | 14352, 14353 | Electrical Safety IL, OL |
| T733 | 13724, 13725 | Motor Vehicle IL, OL |
| T743 | 13727, 13728, 13729 | Hexavalent IL, OL, Parent |
| T749 | 13730 | Cadmium Plating IL |
| + more | ... | See audit CSV for full list |

---

## Step 2: Created Missing Courses

### Script: `scripts/create-missing-courses.ts`

Found 12 courses in external_training that **never existed** in our courses table (weren't part of any merge):

| Course ID | Course Name |
|-----------|-------------|
| 13653 | SPPIVT T586 Bead Blasting- Plastic and Glass Media (OJT) |
| 14598 | SPPIVT T586 Bead Blasting - Plastic and Glass Media (IL OL) |
| 13576 | SPPIVT T504 Wave Solder Process (OJT) |
| 13578 | SPPIVT T505 Surface Mount Assembly Process (OJT) |
| 13584 | SPPIVT T508 Welding-Aluminum (OJT) |
| 14102 | SPPIVT QOP 523 Rework for Non-Surface Mount (Parent) |
| 14104 | SPPIVT QOP 524 Rework for Surface Mount (Parent) |
| 14111 | SPPIVT QOP 525B MRO Rework/Repair Surface Mount (Parent) |
| 14258 | SPPIVT QOP 471C Mechanical Soldering-Tear Banding (Parent) |
| 14262 | SPPIVT QOP 471B Mechanical Soldering-Torch Soldering (Parent) |
| 14264 | SPPIVT QOP 471A Mechanical Soldering-Conductive (Parent) |
| 14297 | SPPIVT QOP 505B Torch Brazing except Aluminum (Parent) |

---

## Step 3: Fixed MG_ Bucket Contents

### The Problem

The MG_ migration buckets (created Dec 4th) contained **every course** from employee_training, not just "overflow" courses from the CSV that weren't in their other positions.

### Original Intended Flow
1. Import courses from CSV not in system
2. For each employee, find courses from CSV they had that **weren't in any of their existing positions**
3. Create MG_ bucket with **only those overflow courses**
4. CSV Compare shows 1:1 matches
5. Management reviews Course Cleanup for duplicates to prune

### Script: `scripts/fix-mg-buckets.ts`

| Metric | Count |
|--------|-------|
| MG_ buckets processed | 682 |
| Incorrect entries deleted | 4,717 |
| Correct entries added | 11,154 |

---

## Step 4: Created Missing MG_ Buckets

### Script: `scripts/create-missing-mg-buckets.ts`

Found 136 employees who had external_training courses but **no MG_ bucket** was ever created for them.

| Metric | Value |
|--------|-------|
| Employees needing buckets | 136 |
| New MG_ buckets created | 134 |
| Already existed | 2 |
| Courses added | 590 |
| Position ID range | 777682 - 777815 |

---

## Step 5: Created Missing Training Records

### The Problem

After recreating courses and MG_ buckets, some employees still showed "Not Found" in CSV Compare. The courses were in their positions, but **no employee_training record existed**.

This happened because:
1. The 12 "missing courses" we created were never part of any merge
2. When we recreated them, we added them to MG_ buckets
3. But we didn't import the training records from external_training

### Script: `scripts/create-missing-training-records.ts`

| Metric | Value |
|--------|-------|
| Missing training records found | 181 |
| Employees affected | 83 |
| Training records created | 181 |

### Example: Reid Lumbra
Before fix - 3 courses showing "Not Found":
- 14297 (QOP 505B Torch Brazing Parent)
- 14598 (T586 Bead Blasting IL OL)
- 13653 (T586 Bead Blasting OJT)

These courses were in his MG_LumbraReid bucket, but had no training record. After creating the records, they show as "Accounted For".

---

## Final Verification

### Script: `scripts/verify-csv-match.ts`

| Metric | Value |
|--------|-------|
| External training course-employee combos | 33,073 |
| Matched in positions | 33,073 |
| **Match rate** | **100.00%** |

---

## System State After Today

### What's In Place
- **All courses from external CSV exist** in our courses table (1:1 ID match)
- **All employees have their CSV courses** in their positions (either regular positions or MG_ buckets)
- **All employees have training records** for their CSV courses
- **CSV Compare shows 100% matches**

### MG_ Buckets Summary
| Metric | Value |
|--------|-------|
| Total MG_ buckets | 816 |
| Total courses in MG_ buckets | 11,744 |
| Position ID range | 777000 - 777815 |

### Next Steps (for management)
1. Review Course Cleanup page for duplicate courses (same T-code, different IDs like T586 Parent vs T586 OJT)
2. Decide which duplicates to merge/delete
3. After cleanup, MG_ positions can be reviewed/removed as needed

---

## Scripts Created Today

| Script | Purpose |
|--------|---------|
| `scripts/revert-course-merges.ts` | Reverted Dec 4th course merges |
| `scripts/create-missing-courses.ts` | Created 12 missing courses |
| `scripts/fix-mg-buckets.ts` | Fixed MG_ bucket contents (11,154 entries) |
| `scripts/create-missing-mg-buckets.ts` | Created 134 missing MG_ buckets |
| `scripts/create-missing-training-records.ts` | Created 181 missing training records |
| `scripts/verify-csv-match.ts` | Verifies CSV match rate |
| `scripts/find-missing-training-records.ts` | Found missing training records |
| `scripts/find-missing-mg-buckets.ts` | Found employees without MG_ buckets |
| `scripts/investigate-missing.ts` | Debug: investigated missing courses |
| `scripts/check-partial-match.ts` | Debug: checked partial matches |
| `scripts/check-lumbra.ts` | Debug: investigated Reid Lumbra's missing courses |

---

## UI Changes

- Renamed "Anomalies" page to "Worklog" with two tabs:
  - **Bugs** - Track issues and anomalies
  - **Timeline** - Shows pending tasks and completed milestones
- Updated sidebar banner to "Check Worklog for bugs/timeline"
- Updated Course Cleanup page text to reference "Torrie's CSV"

### Timeline Order (decided with user)
1. **CSV Compare Validation** (DONE) - All entries from Torrie's CSV are in our system
2. **Management Review of Course Cleanup** (PENDING) - Review duplicate courses, may change names
3. **Process Position Course Removals** (PENDING) - Jivon's Excel file (Training_change.csv) - must wait for management review since course names may change

---

## Key Lesson Learned

**Don't merge courses automatically.** The external system (QOP) has specific course IDs that need to match 1:1 with our database. Merging "duplicate" courses (like T586 Parent + T586 OJT + T586 IL OL) breaks this mapping.

Instead, let management review duplicates in the Course Cleanup page and decide what to consolidate. The system should preserve all original course IDs from the CSV import.

---
