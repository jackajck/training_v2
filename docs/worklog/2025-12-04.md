# Worklog - December 4, 2025

## Migrated External Training "Not Found" Courses into Database
**Type:** Major Feature

Migrated all "Not Found" courses from the external training data (CSV Compare) into our system. These were courses that existed in our database but employees didn't have training records for.

### Migration Approach
- Created a **migration position** for each employee with missing courses (named `MG_{LastNameFirstName}`)
- Linked the missing courses to that position
- Assigned the position to the employee
- Created training records with expiration dates from the external data

### Migration Stats
| Metric | Count |
|--------|-------|
| Migration positions created | 681 |
| Training records added | 2,291 |
| Position ID range | 777000 - 777680 |
| Employees skipped (no missing courses) | 129 |

### Why This Approach?
The employee page displays training requirements based on positions. By creating a migration position with the missing courses, they now appear on each employee's page under their `MG_` position block. This makes the imported data visible and trackable within the existing system.

### Changes:
- Created `scripts/migrate-external-training.ts` - migration script with dry-run support
- Migration positions use 777xxx ID range to distinguish from regular positions (555xxx)

### Rollback Commands (if needed):
```sql
-- Delete training records
DELETE FROM employee_training WHERE notes = 'Migrated from external training data';

-- Delete position assignments
DELETE FROM employee_positions WHERE position_id IN (SELECT position_id FROM positions WHERE position_name LIKE 'MG_%');

-- Delete position courses
DELETE FROM position_courses WHERE position_id IN (SELECT position_id FROM positions WHERE position_name LIKE 'MG_%');

-- Delete positions
DELETE FROM positions WHERE position_name LIKE 'MG_%';
```

---

## Expanded Position ID Range
**Type:** Improvement

Expanded the auto-generated position ID range from 555000-555999 (1,000 slots) to 555000-559999 (5,000 slots) to accommodate future growth.

### Changes:
- Updated `/api/positions/create/route.ts` - new range validation
- Updated `/app/new-position/page.tsx` - updated info text

---

## Disabled External Training Compare Report
**Type:** UI Change

Disabled the External Training Compare report on the Custom Reports page since all external training data has been migrated into the system. The report is now grayed out with an explanation.

---

## Merged 33 Duplicate Courses
**Type:** Data Cleanup

Merged 33 courses that had duplicate names (same course, different IDs). Used scoring system to pick winner based on position count and training record count.

### Stats
- 33 duplicate course sets merged
- 33 duplicate courses deleted
- 8 empty course groups cleaned up

### Merged Courses Lookup Table
Created `merged_courses` table to track 10 course IDs that were merged where the external system ID was the "loser". This allows CSV Compare to show these as "Merged IDs" instead of "Not in DB".

| Old ID | New ID | Course Name |
|--------|--------|-------------|
| 13576 | 999026 | SPPIVT T504 Wave Solder Process (OJT) |
| 13578 | 999025 | SPPIVT T505 Surface Mount Assembly Process (OJT) |
| 13584 | 999023 | SPPIVT T508 Welding-Aluminum (OJT) |
| 14102 | 14103 | SPPIVT QOP 523 Rework for Non-Surface Mount (OJT) |
| 14104 | 14105 | SPPIVT QOP 524 Rework for Surface Mount (OJT) |
| 14111 | 15115 | SPPIVT QOP 525B MRO Rework/Repair Surface Mount (OJT) |
| 14258 | 14259 | SPPIVT QOP 471C Mechanical Soldering-Tear Banding (OJT) |
| 14262 | 14263 | SPPIVT QOP 471B Mechanical Soldering-Torch Soldering (OJT) |
| 14264 | 14265 | SPPIVT QOP 471A Mechanical Soldering-Conductive (OJT) |
| 14297 | 14298 | SPPIVT QOP 505B Torch Brazing except Aluminum (OJT) |

### Changes:
- Ran `scripts/merge-duplicate-courses.ts`
- Created `merged_courses` table in database
- Updated `/api/csv-compare/route.ts` to check merged_courses table
- Updated `/app/csv-compare/page.tsx` with new "Merged IDs" tab

---

## Merged Course Groups with Same T-Code
**Type:** Data Cleanup

Merged all courses within the same T-code group (e.g., T142, not T142A/B/C) into a single course. This eliminates the need for "group matching" logic - if courses are truly equivalent, they're now just one course.

### Merge Logic
- For each course group with 2+ courses sharing the exact same T-code
- Pick the "winner" = course with shortest/plainest name (no PARENT, IL, OL suffix)
- Transfer all `position_courses` and `employee_training` records to the winner
- Delete the duplicate courses
- Handle conflicts: if position/employee already has winner course, skip duplicate

### Stats
| Metric | Count |
|--------|-------|
| Groups merged | 47 |
| Courses deleted | 74 |
| Positions transferred | 1,221 |
| Trainings transferred | 1,762 |

### Also Removed
- Deleted obsolete course 999015 (T532B1) - was incorrectly grouped with T532A, had 0 positions/trainings

### Audit Log
Full audit trail saved to `course-merge-audit-2025-12-04.csv` with details on every merge, transfer, and deletion.

### Example: T142 Before/After
**Before:** 3 courses (13533, 13534, 999019)
**After:** 1 course (13534) with 112 positions, 151 trainings

### Changes:
- Created `scripts/merge-course-groups.ts` - merge script with dry-run support
- Audit CSV at `docs/course-merge-audit-2025-12-04.csv`

---

## Merged Additional T-Code Duplicates (Not in Groups)
**Type:** Data Cleanup

Found 45 additional T-codes with duplicate courses that were never added to course groups. Merged all of them using the same logic (shortest name wins).

### Stats
| Metric | Count |
|--------|-------|
| T-codes merged | 45 |
| Courses deleted | 48 |
| Positions transferred | 110 |
| Trainings transferred | 97 |

Also manually merged T586 (3 courses → 1) and renamed to remove "(Parent)" suffix.

### Additional Fixes
- Activated 5 winner courses that were inactive: T586, T701, T709, T733, T749
- Renamed T586 from "Bead Blast Training (Parent)" to "Bead Blast Training"

### Final State
- **263 total courses** remaining
- **No duplicate T-codes** - each T-code now has exactly 1 course

---

## Updated Sidebar Banner
**Type:** UI Change

Updated yellow banner to show recent changes:
- CSV Migration 12/4
- TCourses Condensed 12/4

---

## T-Code Matching for Condensed Courses in CSV Compare
**Type:** Feature

Added T-code matching so condensed courses (e.g., T717 Parent, IL, OL merged into one) now show as "Accounted For" instead of "Course Not in DB".

### How It Works
- When a course ID from external data isn't found in our database, extract the T-code from the course name
- Check if that T-code exists in any course in our database
- If found, mark it as a T-code match (cyan badge)

### Visual Grouping
Added visual grouping for T-code matches that point to the same consolidated course:
- Cyan dots on the left side connecting related courses
- Vertical lines linking courses in the same T-code group
- Subtle cyan background tint on grouped rows
- Shows "T-Code: T717 → ID 13534" to indicate the mapping

### Changes:
- Updated `/api/csv-compare/route.ts` - added T-code lookup and tCodeMatches category
- Updated `/app/csv-compare/page.tsx` - visual grouping with dots/lines, cyan badge for T-code matches

---
