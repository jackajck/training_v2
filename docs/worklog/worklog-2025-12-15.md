# Worklog - December 15, 2025

## Summary

Added Q Course Specialization feature - allows marking which Q courses (QOP/QCD) an employee actually needs vs. which ones are "not needed." This addresses the problem where positions like QOP 497 Electrical Soldering have 8+ course variants, but employees typically only need 1-2 of them.

---

## 1. Q Course Specialization Feature

### The Problem

Positions like **QOP 497 Electrical Soldering** contain multiple course variants (497A, 497B, 497D, 497F, 497G, 497K, 497L, 497T), but employees typically only need 1-2 of these, not all 8. Previously, all variants showed as "Missing" which created noise and made it hard to see actual training gaps.

### What Are Q Courses?

Q courses are special training courses that have multiple variants - employees typically only need 1-2 variants, not all of them. The feature detects Q courses by looking for these patterns in the course name:

| Pattern | Count | Example |
|---------|-------|---------|
| **QOP** | 97 | SPPIVT QOP 497A Electrical Soldering (OJT) |
| **QCD** | 4 | SPPIVT QCD Inspection (IL) |
| **Total** | **101** | |

Only these two types (QOP and QCD) get the clickable dot treatment. All other courses work normally.

### Solution: Clickable Dots

In the Employee page, Q courses now have **clickable dots** in the position timeline:

- **Gray dot + strikethrough** = "Not Needed" for this employee
- **Colored dot** (green/red/orange/blue) = Needed, shows actual training status
- Click to toggle between needed/not needed
- Non-Q courses work the same as before (not clickable)

### Database Table Created

**`employee_q_courses`**

| Column | Type | Description |
|--------|------|-------------|
| id | SERIAL | Primary key |
| employee_id | INTEGER | Links to employee |
| course_id | VARCHAR(20) | The Q course ID |
| is_needed | BOOLEAN | true = needed, false = not needed |
| created_at | TIMESTAMP | When created |
| updated_at | TIMESTAMP | Last updated |

**Default behavior:** Q courses default to "not needed" - they only count toward missing/expired if explicitly marked as needed.

### API Endpoint

| Endpoint | Method | Description |
|----------|--------|-------------|
| `/api/employees/q-courses` | GET | Fetch Q course assignments for an employee |
| `/api/employees/q-courses` | POST | Toggle Q course needed status |

---

## 2. Employee Page UI Changes

### Condensed Header

The employee info header was condensed from large boxes to a single inline row:

**Before:**
```
+----------------------------------+
| Role                             |
| [large input box               ] |
+----------------------------------+
| Job Code     | Leader            |
| [box]        | [dropdown      ]  |
+----------------------------------+
```

**After:**
```
Role: Assembler [pen] | Leader: [dropdown]
```

- Removed Job Code field entirely
- Role and Leader on single line
- More vertical space for positions list

### Q Course Toggle in Positions

In the middle column positions list:
- Q courses (QOP/QCD) have clickable dots
- Hover shows ring effect to indicate clickability
- Click toggles between needed (colored) and not needed (gray)
- Not needed courses show strikethrough text

### Training Requirements (Right Column)

- Q courses marked as "not needed" show gray "Not Needed" badge
- Rows for not-needed courses have 50% opacity
- Summary counts at top exclude not-needed Q courses

---

## 3. Org Tree Query Updates

Updated org tree APIs to exclude Q courses marked as "not needed" from missing/expired counts:

| File | Change |
|------|--------|
| `app/api/org-tree/team-stats/route.ts` | JOINs to `employee_q_courses`, filters out not-needed Q courses |
| `app/api/org-tree/training-overview/route.ts` | Same - excludes from expired/missing counts |
| `app/api/org-tree/team-with-stats/route.ts` | Same - per-employee stats exclude not-needed |

**Main page unchanged** - it only shows expiring (completed) training, not missing courses, so Q course filtering isn't needed there.

---

## 4. Timeline Dot Alignment Fix

Fixed the vertical timeline line in position course lists - was slightly off-center from the dots. Changed from `left-2` to `left-[0.625rem]` for better alignment.

---

## Files Created

| File | Purpose |
|------|---------|
| `scripts/create-employee-q-courses-table.ts` | Database migration for employee_q_courses table |
| `app/api/employees/q-courses/route.ts` | API for fetching/toggling Q course assignments |
| `docs/Q_COURSES_PROPOSAL.md` | Design doc for the feature |

## Files Modified

| File | Changes |
|------|---------|
| `app/employees/page.tsx` | Condensed header, clickable Q course dots, "Not Needed" status display |
| `app/api/org-tree/team-stats/route.ts` | Exclude not-needed Q courses from counts |
| `app/api/org-tree/training-overview/route.ts` | Exclude not-needed Q courses from counts |
| `app/api/org-tree/team-with-stats/route.ts` | Exclude not-needed Q courses from counts |

---

## How It Works

1. **Q courses identified by name** - contains "QOP" or "QCD"
2. **Default is "not needed"** - Q courses only count if explicitly marked as needed
3. **Toggle persists** - stored in `employee_q_courses` table
4. **Survives position removal** - if position is removed and re-added, settings remain
5. **Per-employee** - each employee can have different Q courses marked as needed

---

## 5. Additional UI Refinements

### Role/Leader Layout Fix

Fixed issue where long role names would push the Leader dropdown to a new line on some employees.

**Before:** `flex-wrap` - would wrap unpredictably based on content length

**After:** `grid grid-cols-3` - fixed 2/3 for Role, 1/3 for Leader

- Role takes `col-span-2` (2/3 width)
- Leader takes `col-span-1` (1/3 width)
- Leader dropdown set to `w-20` (shows ~5 characters)
- Always on same line regardless of name length

---

## 6. Test Data

Added expired QOP 497A training record to Burke,John (employee_id 538) for testing the expired Q course UI.

---

## Next Steps

- Train users on clicking dots to mark Q courses as needed
- Consider bulk assignment tool if needed
- Monitor for any edge cases with org tree counts
